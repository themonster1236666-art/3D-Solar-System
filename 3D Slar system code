<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Textured Solar System Simulator</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js library --><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Load OrbitControls for smooth camera interaction --><script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1e;
        }
        canvas {
            display: block;
        }
        #info-panel {
            position: absolute;
            top: 0;
            left: 0;
            padding: 1rem;
            background-color: rgba(10, 10, 20, 0.8);
            color: #e0f2fe;
            border-radius: 0 0 8px 0;
            z-index: 10;
        }
        .planet-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0d0d1e;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #e0f2fe;
            font-size: 1.5rem;
            z-index: 100;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin-top: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'space-dark': '#0d0d1e',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="loading-screen">
        <p>Loading Solar System Textures...</p>
        <div class="spinner"></div>
    </div>

    <div id="info-panel" class="shadow-lg border-b border-r border-blue-900">
        <h1 class="text-xl font-bold text-blue-400 mb-2">Textured Solar System</h1>
        <p class="text-sm">Drag to orbit, scroll to zoom.</p>
        <p class="text-sm text-yellow-500">All major planets with high-res textures.</p>
    </div>
    <div id="labels-container"></div>

    <script type="module">
        // Global variables for Three.js scene
        let scene, camera, renderer, controls, clock;
        const labels = {}; // Store planet labels for 3D positioning
        const planets = []; // Store planet data
        const textureLoader = new THREE.TextureLoader();
        let manager;

        // Constants for the solar system
        const AU = 150; // Astronomical Unit factor for scaling orbits
        const sunRadius = 10;
        const RES_HIGH = 128; // High polygon count for textured planets

        /**
         * Initializes the Three.js scene, camera, and renderer.
         */
        function init() {
            try {
                // Loading Manager for textures
                manager = new THREE.LoadingManager();
                manager.onStart = function (url, itemsLoaded, itemsTotal) {
                    document.getElementById('loading-screen').style.display = 'flex';
                };
                manager.onLoad = function () {
                    document.getElementById('loading-screen').style.display = 'none';
                    animate(); // Start animation only after all textures are loaded
                };
                manager.onProgress = function (url, itemsLoaded, itemsTotal) {
                    console.log(`Loading file: ${url}.\nLoaded ${itemsLoaded} of ${itemsTotal} files.`);
                };
                manager.onError = function (url) {
                    console.error('There was an error loading ' + url);
                    document.getElementById('loading-screen').innerHTML = `<h1 class="text-xl font-bold text-red-500 mb-2">LOADING ERROR</h1><p>Failed to load textures. Please check your internet connection or try again later. (Error loading ${url})</p>`;
                };


                // 1. Scene Setup
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000000); // Black background for space
                clock = new THREE.Clock();

                // 2. Camera Setup
                const aspect = window.innerWidth / window.innerHeight;
                camera = new THREE.PerspectiveCamera(50, aspect, 0.1, 10000);
                camera.position.set(0, AU * 2, AU * 8); // Slightly further back to see more
                camera.lookAt(scene.position);

                // 3. Renderer Setup
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.toneMapping = THREE.ReinhardToneMapping;
                renderer.toneMappingExposure = 1.8; 
                document.body.appendChild(renderer.domElement);

                // 4. Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.2); // Dim ambient light
                scene.add(ambientLight);

                const sunLight = new THREE.PointLight(0xffffff, 5000, 0, 2); // Intense sun light
                sunLight.position.set(0, 0, 0);
                scene.add(sunLight);

                // 5. Sun (Emissive, no texture needed)
                const sunGeometry = new THREE.SphereGeometry(sunRadius, RES_HIGH, RES_HIGH);
                const sunMaterial = new THREE.MeshBasicMaterial({
                    color: 0xffa500,
                    emissive: 0xffa500,
                    emissiveIntensity: 1.5 
                });
                const sun = new THREE.Mesh(sunGeometry, sunMaterial);
                sun.name = 'Sun';
                scene.add(sun);

                // 6. Starfield Background
                const starGeometry = new THREE.SphereGeometry(4000, 64, 64);
                const starMaterial = new THREE.MeshBasicMaterial({
                    map: createStarTexture(),
                    side: THREE.BackSide, 
                });
                const starSphere = new THREE.Mesh(starGeometry, starMaterial);
                scene.add(starSphere);

                // 7. Create Planets (with textures)
                createPlanet({
                    name: 'Mercury', radius: 1.5, distance: 0.4 * AU, orbitSpeed: 4.15, rotationSpeed: 0.005,
                    texture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/mercurymap.jpg'
                });
                createPlanet({
                    name: 'Venus', radius: 3, distance: 0.7 * AU, orbitSpeed: 1.62, rotationSpeed: 0.003,
                    texture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/venusmap.jpg'
                });
                createPlanet({
                    name: 'Earth', radius: 3.5, distance: 1.0 * AU, orbitSpeed: 1.0, rotationSpeed: 0.02,
                    texture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/earthmap1k.jpg',
                    specularMap: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/earthspec1k.jpg',
                    bumpMap: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/earthbump1k.jpg'
                });
                createPlanet({
                    name: 'Mars', radius: 2.2, distance: 1.5 * AU, orbitSpeed: 0.53, rotationSpeed: 0.015,
                    texture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/marsmap1k.jpg'
                });
                createPlanet({
                    name: 'Jupiter', radius: 7, distance: 5.2 * AU, orbitSpeed: 0.08, rotationSpeed: 0.05,
                    texture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/jupitermap.jpg'
                });
                createPlanet({
                    name: 'Saturn', radius: 6, distance: 9.5 * AU, orbitSpeed: 0.03, rotationSpeed: 0.045,
                    texture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/saturnmap.jpg',
                    hasRings: true,
                    ringInnerRadius: 8,
                    ringOuterRadius: 15,
                    ringSegments: RES_HIGH,
                    ringTexture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/saturnringcolor.jpg'
                });
                 createPlanet({
                    name: 'Uranus', radius: 5, distance: 19.2 * AU, orbitSpeed: 0.012, rotationSpeed: 0.03,
                    texture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/uranusmap.jpg',
                    hasRings: true,
                    ringInnerRadius: 6,
                    ringOuterRadius: 9,
                    ringSegments: RES_HIGH,
                    ringTexture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/uranusringcolour.jpg'
                });
                createPlanet({
                    name: 'Neptune', radius: 4.8, distance: 30.1 * AU, orbitSpeed: 0.006, rotationSpeed: 0.035,
                    texture: 'https://cdn.rawgit.com/jeromeetienne/threex.planets/master/images/neptunemap.jpg'
                });


                // 8. Orbit Controls (for user camera movement/touch drag)
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true; 
                controls.dampingFactor = 0.05;
                controls.screenSpacePanning = false;
                controls.minDistance = sunRadius * 1.5;
                controls.maxDistance = AU * 40; // Allow zooming out further

                // 9. Event Listeners
                window.addEventListener('resize', onWindowResize, false);
                
                // Animation starts only after textures are loaded (manager.onLoad)

            } catch (error) {
                console.error("Three.js/WebGL Initialization Failed:", error);
                document.getElementById('info-panel').innerHTML = `<h1 class="text-xl font-bold text-red-500 mb-2">CRITICAL ERROR</h1><p>3D scene failed to load. Your device or environment may not support WebGL or the required features. Error: ${error.message}</p>`;
            }
        }

        /**
         * Creates a texture for the starfield background.
         */
        function createStarTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < 2000; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 0.7 + 0.1;
                const color = `rgba(255, 255, 255, ${Math.random() * 0.8 + 0.4})`;
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
            }

            return new THREE.CanvasTexture(canvas);
        }

        /**
         * Creates a single planet, its orbit path, and an HTML label.
         */
        function createPlanet(config) {
            const { name, radius, distance, orbitSpeed, rotationSpeed, texture, specularMap, bumpMap,
                    hasRings = false, ringInnerRadius, ringOuterRadius, ringSegments, ringTexture } = config;

            // --- 1. Create Planet Mesh (Sphere) ---
            const geometry = new THREE.SphereGeometry(radius, RES_HIGH, RES_HIGH);
            const materialOptions = {
                map: textureLoader.load(texture, manager.itemStart, manager.itemEnd, manager.itemError),
                shininess: 5,
                specular: 0x333333 // Default specular color
            };

            if (specularMap) {
                materialOptions.specularMap = textureLoader.load(specularMap, manager.itemStart, manager.itemEnd, manager.itemError);
                materialOptions.shininess = 20; // More shine for Earth's oceans
            }
            if (bumpMap) {
                materialOptions.bumpMap = textureLoader.load(bumpMap, manager.itemStart, manager.itemEnd, manager.itemError);
                materialOptions.bumpScale = 0.05; // Adjust for realistic bump effect
            }

            const material = new THREE.MeshPhongMaterial(materialOptions);
            const planetMesh = new THREE.Mesh(geometry, material);
            planetMesh.name = name;
            scene.add(planetMesh);

            // --- 2. Create Rings (for Saturn, Uranus) ---
            if (hasRings) {
                const ringGeometry = new THREE.RingGeometry(ringInnerRadius, ringOuterRadius, ringSegments);
                const ringMaterial = new THREE.MeshPhongMaterial({
                    map: textureLoader.load(ringTexture, manager.itemStart, manager.itemEnd, manager.itemError),
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.9,
                    shininess: 5
                });
                const ringMesh = new THREE.Mesh(ringGeometry, ringMaterial);
                ringMesh.rotation.x = Math.PI / 2;
                planetMesh.add(ringMesh); 
            }

            // --- 3. Create Orbit Path (Circle) ---
            const segments = 256; 
            const orbitGeometry = new THREE.RingGeometry(distance - 0.2, distance + 0.2, segments);
            const orbitMaterial = new THREE.MeshBasicMaterial({
                color: 0x555555,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.3
            });
            const orbitMesh = new THREE.Mesh(orbitGeometry, orbitMaterial);
            orbitMesh.rotation.x = Math.PI / 2;
            scene.add(orbitMesh);

            // --- 4. Create HTML Label ---
            const labelDiv = document.createElement('div');
            labelDiv.className = 'planet-label';
            labelDiv.textContent = name;
            document.getElementById('labels-container').appendChild(labelDiv);

            // Store data for animation
            planets.push({ mesh: planetMesh, distance, orbitSpeed, rotationSpeed, label: labelDiv });
        }


        /**
         * Main animation loop.
         */
        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();
            const elapsedTime = clock.getElapsedTime();

            // Update planet positions and rotations
            planets.forEach(planet => {
                const { mesh, distance, orbitSpeed, rotationSpeed } = planet;

                // Orbit motion (around the sun)
                const angle = elapsedTime * orbitSpeed * 0.2; 
                mesh.position.x = distance * Math.cos(angle);
                mesh.position.z = distance * Math.sin(angle);

                // Planet rotation (self-spin)
                mesh.rotation.y += rotationSpeed * delta * 60; 

                // Update HTML label position
                updateLabelPosition(mesh, planet.label);
            });

            // Update controls and render the scene
            controls.update();
            renderer.render(scene, camera);
        }

        /**
         * Converts 3D planet position to 2D screen coordinates for HTML label.
         */
        function updateLabelPosition(mesh, label) {
            const vector = new THREE.Vector3();
            mesh.getWorldPosition(vector);
            vector.project(camera);

            const width = window.innerWidth;
            const height = window.innerHeight;
            const x = (vector.x * 0.5 + 0.5) * width;
            const y = (-vector.y * 0.5 + 0.5) * height;

            label.style.left = `${x}px`;
            label.style.top = `${y}px`;

            const isVisible = vector.z < 1;
            label.style.opacity = isVisible ? '1' : '0';
            label.style.transform = `translate(-50%, -50%)`;
        }

        /**
         * Handles window resize event to keep the scene responsive.
         */
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Initialize the 3D environment when the window loads
        window.onload = function () {
            // Container for HTML labels
            const labelsContainer = document.createElement('div');
            labelsContainer.id = 'labels-container';
            document.body.appendChild(labelsContainer);
            init();
        };

    </script>
</body>
</html>
